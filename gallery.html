<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Gallery - VR Image Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <style>
        #loadingOverlay {
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            position: sticky;
            top: 56px;
            z-index: 1000;
            display: none;
        }

        .card-img-top {
            max-height: 200px;
            object-fit: cover;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">VR Gallery</div>
        <nav>
            <a href="index.html">Home</a>
            <a href="gallery.html">Gallery</a>
        </nav>
    </header>

    <div id="loadingOverlay">Loading gallery, please wait...</div>

    <div class="container mt-3">
        <div class="row" id="galleryContainer"></div>
    </div>

    <a-scene id="vrScene" embedded style="display:none; height:100%; width:100%;">
        <a-assets><img id="panorama" crossorigin="anonymous"></a-assets>
        <a-sky id="sky" rotation="0 -90 0"></a-sky>
        <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const IMAGES = ['images/img1.heic', 'images/img2.heic', 'images/img3.heic'];
            const PREVIEWS = ['images/img1_preview.jpeg', 'images/img2_preview.jpeg', 'images/img3_preview.jpeg'];

            const galleryEl = document.getElementById('galleryContainer');
            const loaderEl = document.getElementById('loadingOverlay');
            const vrSceneEl = document.getElementById('vrScene');
            const skyEl = document.getElementById('sky');
            const panoramaEl = document.getElementById('panorama');  // A-Frame asset

            // Helper: resolve relative paths against the page URL
            const toUrl = (path) => new URL(path, window.location.href).href;

            console.log('[Gallery] initializing with', IMAGES.length, 'images');
            loaderEl.style.display = 'block';

            IMAGES.forEach((relSrc, idx) => {
                const srcUrl = toUrl(relSrc);
                const previewUrl = toUrl(PREVIEWS[idx]);

                // Build card
                const col = document.createElement('div');
                const card = document.createElement('div');
                const img = document.createElement('img');
                const btn = document.createElement('button');
                const err = document.createElement('div');

                col.className = 'col-md-4 mb-4';
                card.className = 'card';
                img.className = 'card-img-top';
                btn.className = 'btn btn-primary m-3';
                err.className = 'text-danger m-3';

                img.src = previewUrl;
                img.alt = 'Preview image';
                img.onerror = () => {
                    img.alt = 'Preview failed';
                    console.warn(`[Gallery] preview ${previewUrl} failed to load`);
                };

                btn.innerText = 'Open in VR';
                card.append(img, btn, err);
                col.appendChild(card);
                galleryEl.appendChild(col);

                if (idx === IMAGES.length - 1) {
                    loaderEl.style.display = 'none';
                    console.log('[Gallery] all cards appended, hiding loader');
                }

                btn.addEventListener('click', async () => {
                    console.log(`[Gallery] click on ${relSrc}`);
                    err.textContent = '';
                    btn.disabled = true;
                    btn.innerText = 'Loading…';

                    try {
                        console.log(`[Gallery] fetching ${srcUrl}`);
                        const res = await fetch(srcUrl);
                        console.log(`[Gallery] fetch response:`, res.status);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);

                        let blob = await res.blob();
                        console.log('[Gallery] got blob:', blob);

                        if (relSrc.toLowerCase().endsWith('.heic')) {
                            console.log('[Gallery] converting HEIC → JPEG');
                            blob = await heic2any({ blob, toType: 'image/jpeg' });
                            console.log('[Gallery] conversion complete:', blob);
                        }

                        const dataUrl = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = () => reject(reader.error);
                            reader.readAsDataURL(blob);
                        });
                        console.log('[Gallery] Data URL ready (length):', dataUrl.length);

                        // Proper A-Frame asset update:
                        panoramaEl.setAttribute('src', dataUrl);
                        skyEl.setAttribute('src', '#panorama');

                        vrSceneEl.style.display = 'block';
                        document.body.classList.add('vr-active');
                        console.log('[Gallery] VR scene displayed');

                        // Ensure the texture actually updates
                        const mesh = skyEl.getObject3D('mesh');
                        if (mesh?.material?.map) {
                            mesh.material.map.needsUpdate = true;
                            console.log('[Gallery] forced material.update');
                        }

                        // Auto-trigger VR button
                        (function triggerVR() {
                            const vrBtn = document.querySelector('.a-enter-vr-button');
                            if (vrBtn) {
                                console.log('[Gallery] clicking A-Frame VR button');
                                vrBtn.click();
                            } else {
                                window.requestAnimationFrame(triggerVR);
                            }
                        })();

                    } catch (fetchErr) {
                        console.error('[Gallery] error:', fetchErr);
                        err.textContent = `Error: ${fetchErr.message}`;
                    } finally {
                        btn.disabled = false;
                        btn.innerText = 'Open in VR';
                    }
                });
            });

            // Cleanup when exiting fullscreen/VR
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    document.body.classList.remove('vr-active');
                    vrSceneEl.style.display = 'none';
                    console.log('[Gallery] VR scene hidden (fullscreen exit)');
                }
            });
        });

    </script>
</body>

</html>