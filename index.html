<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>360Â° Panorama Viewer</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <style>
        #fileInput {
            position: absolute;
            z-index: 2;
            margin: 10px;
        }

        #image2D {
            display: none;
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 80%;
            max-height: 80%;
            z-index: 1;
        }

        a-scene {
            display: none;
        }
    </style>
</head>

<body>
    <input type="file" id="fileInput" accept="image/*" />
    <img id="image2D" />

    <a-scene id="vrScene">
        <a-assets>
            <img id="panorama" crossorigin="anonymous" />
        </a-assets>
        <a-sky id="sky" rotation="0 -90 0"></a-sky>
        <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
        const fileInput = document.getElementById('fileInput');
        const sky = document.getElementById('sky');
        const panorama = document.getElementById('panorama');
        const image2D = document.getElementById('image2D');
        const vrScene = document.getElementById('vrScene');

        fileInput.addEventListener('change', async function (event) {
            const file = event.target.files[0];
            const extension = file.name.split('.').pop().toLowerCase();

            if (!file) return;

            // HEIC image: decode and use in VR
            if (extension === 'heic') {
                try {
                    const blob = await heic2any({ blob: file, toType: "image/jpeg" });
                    const reader = new FileReader();
                    reader.onload = function () {
                        const dataUrl = reader.result;

                        // Check that result is a valid base64 image
                        if (!dataUrl.startsWith('data:image')) {
                            alert('Failed to convert HEIC properly.');
                            return;
                        }

                        panorama.setAttribute('src', dataUrl);
                        sky.setAttribute('src', '#panorama');
                        vrScene.style.display = 'block';
                        image2D.style.display = 'none';

                        // Force reloading sky with a delay (in case A-Frame misses the update)
                        setTimeout(() => {
                            sky.setAttribute('src', dataUrl);
                        }, 500);
                    };
                    reader.readAsDataURL(blob);
                } catch (e) {
                    alert("Error decoding HEIC: " + e.message);
                    console.error(e);
                }
            } else if (file.type.startsWith('image/')) {
                // Fallback: render regular image as 2D
                const reader = new FileReader();
                reader.onload = function () {
                    image2D.src = reader.result;
                    image2D.style.display = 'block';
                    vrScene.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                alert("Unsupported file format.");
            }
        });
    </script>
</body>

</html>